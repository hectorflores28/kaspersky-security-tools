# Software Malicioso (Malware)

## Definición y Propósito
El software malicioso o malware es un tipo de software diseñado para:
- Alterar el funcionamiento del sistema de un ordenador
- Robar información confidencial
- Causar algún tipo de daño

Todo esto sin que el usuario se dé cuenta.

## Características Clave
- Cualquier software de administración remota puede utilizarse para fines ilegítimos
- Los mismos programas pueden ser utilizados tanto por administradores de sistemas como por atacantes
- Algunos procesos legítimos no tienen descripción
- Windows incluye un "Proceso inactivo del sistema" que muestra el porcentaje de recursos disponibles

> **Nota Importante**: Debido a que el ser humano es capaz de comprender íntegramente el contexto, siempre existe la posibilidad de que los programas antivirus no detecten el malware.

## Tipos de Software Malicioso

### Ejemplos Básicos
```bash
# Ejemplo de malware que añade una "A" al final de cada archivo
f=open(file, 'rwa')
f.write("A")
f.close

# Ejemplo de ransomware que cifra archivos
f=open(file,'w')
f.encrypt(key)
f.close
```

### Metadatos y Camuflaje
- Los atacantes añaden metadatos (descripción, nombre, icono) para hacer que el malware parezca legítimo
- Los atacantes menos experimentados suelen olvidar esto o solo copian metadatos parciales

## Fundamentos de Búsqueda de Malware

### Análisis Heurístico
Método para detectar malware mediante la búsqueda de anomalías:

1. Procesos sin descripción
2. Errores en nombres de procesos:
   - wiinlogon.exe en lugar de winlogon.exe
   - host.exe en lugar de svchost.exe
   - Inicio desde directorios sospechosos

> **Nota**: El análisis heurístico no puede garantizar que un archivo sea malware, pero la probabilidad aumenta con el número de anomalías.

## Herramientas de Análisis

### Process Hacker
- Considerado como RiskTool por proveedores de antivirus
- Requiere excepción en antivirus para su uso
- Muestra metadatos de archivos ejecutables
- Verifica automáticamente firmas digitales
- Detecta procesos empaquetados (alta entropía)

### Process Explorer
- Alternativa a Process Hacker
- Muestra información detallada de procesos
- Permite análisis de memoria y DLLs

## Ubicaciones Sospechosas
### Directorios Legítimos
- C:\Program Files
- C:\Windows\System32

### Directorios Sospechosos
- C:\Users\[Usuario]\AppData\Local\Temp
- Directorio raíz (C:\)
- C:\Program Files\Google Chrome (si el proceso no es chrome.exe)

## Análisis de Red
### Características de Conexiones Sospechosas
- Direcciones con caracteres aleatorios
- Servicios de nombres de dominio dinámico:
  - *.homedns.org
  - *.dyndns.info
  - *.dynalias.com

### Backconnect y DGA
- Backconnect: El malware inicia conexiones periódicas con servidores de control
- DGA (Algoritmo de Generación de Dominios): Genera nombres de dominio basados en datos aleatorios

## Firmas Digitales
- Verifican autenticidad e integridad
- Process Hacker muestra:
  - Trusted: Firma válida
  - Untrusted: Firma no válida
  - Sin valor: Archivo no firmado (señal de alerta)

## Procesos Especiales de Windows
- Solo puede haber uno de:
  - System
  - wininit.exe
  - services.exe
  - Isaas.exe
  - Ism.exe

### Jerarquía de Procesos
- smss.exe siempre es proceso secundario de System
- Procesos adicionales de smss.exe son secundarios del proceso principal

## Métodos de Robo de Contraseñas
1. Registro de pulsaciones de teclas
2. Extracción de bases de datos locales
3. Extracción directa de memoria
4. Ventanas falsas para introducción de contraseñas

## Servicios de Windows
- Muchos servicios funcionan como DLLs
- Se cargan en svchost.exe
- El malware suele desarrollarse como servicio para ejecución automática

## Indicadores de Compromiso (IOC)
Artefactos que permiten determinar infección:
- Hashes de archivos
- Rutas a archivos
- Claves del registro
- Aspectos del tráfico de red

## Ataques de Red
### Denegación de Servicio (DoS)
- Bloqueo de acceso al sistema
- Motivos comunes:
  - Extorsión
  - Competencia
  - Infiltración

### Redes de Bots
- Redes de ordenadores infectados
- Usos:
  - Envío de spam
  - Fuerza bruta
  - Ataques DDoS

## Análisis de Programas de Inicio
### Métodos de Ejecución Automática
1. Carpetas de ejecución automática
2. Claves de registro
3. Programador de tareas
4. Servicios de Windows

### Herramienta Autoruns
- Analiza todas las ubicaciones de ejecución automática
- Muestra información detallada de procesos

## Fuerza Bruta
### Tipos
1. Búsqueda exhaustiva de hashes
2. Búsqueda de contraseñas de acceso

### Ataques de Diccionario
- Contraseñas más frecuentes
- Contraseñas filtradas
- Listas generadas de información pública

## Análisis de Tráfico HTTP
### Fiddler
- Proxy local para análisis HTTP/HTTPS
- Muestra:
  - Lista de conexiones
  - Solicitudes y respuestas
  - Encabezados HTTP

## Inyección de Código
### Objetivos
1. Evadir reglas de firewall
2. Ocultar actividad maliciosa
3. Mantener etiqueta "Trusted"

### Métodos
1. Inserción de DLL
2. Inyección de DLL
3. Inyección de código bruto

### Análisis de Memoria
- Process Explorer > Memory Tab
- Características a buscar:
  - Páginas con derechos RWX
  - Constantes de archivo (MZ, PK, %PDF)

## Inyección Web
El enlace de funciones es un medio que utiliza el malware para modificar los datos de una aplicación legítima:

1. Inserta un módulo en la memoria del proceso que necesita
2. Realiza una búsqueda de una función para interceptar
3. Escribe una redirección en su módulo al comienzo de la función

> **Nota**: El enlace de funciones suele usarse en rootkits de modo usuario para ocultar archivos

La inyección web es una técnica basada en el enlace de funciones, pero que realizan la inyección en un navegador web. Por ejemplo, el troyano Zeus intercepta las funciones que realizan la conexión a internet y modifica el código al inyectar su propio JavaScript.

## VirusTotal
Servicio en línea que analiza archivos y enlaces sospechosos.

> **Nota**: Los dominios de noip.com utilizan un servicio dinámico de DNS (No-IP), comúnmente empleados por malwares para evadir bloqueos basados en IP estática.

## Rootkits

### Rootkits de Modo Kernel
Herramientas que permiten que el malware se oculte en el sistema:

1. Ocultar archivos en un sistema
   - Se logra mediante la intercepción o el enlace determinado de un archivo
2. Ocultar procesos maliciosos
   - Se logra eliminando información acerca del proceso de la lista de procesos del sistema en ejecución
3. Ocultar información acerca de un módulo de ejecución automática o el registro
   - Para ejecutar, el rootkit debe funcionar en modo kernel, debe haber un controlador que intercepte el contacto con el registro

#### Ocultar Procesos en el Kernel
- Método que involucra la alteración de la lista de procesos en ejecución
- Los rootkits pueden modificar el puntero y cortar el proceso en una lista doblemente enlazada
- Process Hacker y el Administrador de tareas no muestran el proceso, ya que se basan en los punteros de esta lista

### Rootkits de Modo Usuario
- Se inyectan en los procesos e interceptan funciones
- Afectan:
  - El sistema de archivos (Archivos en el disco)
  - El registro (Claves de registro)

#### Registrador de Pulsaciones de Teclas
- Utilizan tecnología de rootkit para esconder archivos de datos
- Interceptan el mostrar archivos en el administrador de archivos
- El malware debe mantener el archivo abierto todo el tiempo para escribir en él

> **Nota**: Si encuentra un archivo oculto, siempre debe comprobar si hay un proceso que lo abre

### Identificadores
- Para que el proceso pueda leer y escribir un archivo o clave de registro específica, necesita recibir el puntero que hace referencia al objeto
- En Windows estos punteros se denominan identificadores

## Análisis de Procesos

### Indicadores de Malware
- MZ (4d 5a) al comienzo de la página con derechos RWX
- PID desconocido con nombres sospechosos (ej: ff.exe)
- User-Agent sospechoso en Fiddler (ej: Godzilla)
- Rutas de malware en registro (ej: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run)

### Procesos Específicos
- winword.exe en memoria (0x117e000)
- iexplorer con permisos RWX (0x1830000)
- Procesos con nombres aleatorios (ej: copiquwjvoasirqw78hlkzjc)

### Análisis de CPU
- System Idle con uso anormal de CPU (90%)
- Procesos con alto consumo de CPU (80-99%)
- Hilos sospechosos en ntkrnlpa.exe

## Utilidades contra Rootkits

### GMER
[GMER - Rootkit Detector and Remover](http://www.gmer.net/)

Características:
- Buscar archivos ocultos en el disco
- Buscar procesos ocultos en el sistema
- Buscar identificadores sospechosos dentro de procesos 