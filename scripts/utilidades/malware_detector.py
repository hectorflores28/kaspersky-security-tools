#!/usr/bin/env python3
import os
import sys
import hashlib
import pefile
import magic

def calculate_file_hash(file_path):
    """Calcula el hash MD5 de un archivo"""
    try:
        with open(file_path, 'rb') as f:
            file_hash = hashlib.md5()
            while chunk := f.read(8192):
                file_hash.update(chunk)
        return file_hash.hexdigest()
    except Exception as e:
        print(f"Error al calcular hash: {str(e)}")
        return None

def analyze_pe_file(file_path):
    """Analiza archivos PE (Portable Executable)"""
    try:
        pe = pefile.PE(file_path)
        print("\nInformación del archivo PE:")
        print(f"Tipo de archivo: {'32-bit' if pe.FILE_HEADER.Machine == 0x014c else '64-bit'}")
        print(f"Secciones: {len(pe.sections)}")
        print(f"Importaciones: {len(pe.DIRECTORY_ENTRY_IMPORT)}")
        return True
    except Exception as e:
        print(f"No es un archivo PE válido: {str(e)}")
        return False

def scan_directory(directory):
    """Escanea un directorio en busca de archivos sospechosos"""
    suspicious_extensions = {'.exe', '.dll', '.sys', '.bat', '.ps1', '.vbs'}
    suspicious_files = []
    
    print(f"\nEscaneando directorio: {directory}")
    print("-" * 50)
    
    for root, _, files in os.walk(directory):
        for file in files:
            file_path = os.path.join(root, file)
            file_ext = os.path.splitext(file)[1].lower()
            
            if file_ext in suspicious_extensions:
                print(f"\nAnalizando archivo sospechoso: {file_path}")
                file_hash = calculate_file_hash(file_path)
                if file_hash:
                    print(f"Hash MD5: {file_hash}")
                
                if file_ext in {'.exe', '.dll', '.sys'}:
                    analyze_pe_file(file_path)
                
                suspicious_files.append(file_path)
    
    return suspicious_files

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Uso: python malware_detector.py <directorio>")
        print("Ejemplo: python malware_detector.py C:\\Windows\\System32")
        sys.exit(1)
    
    target_dir = sys.argv[1]
    if not os.path.isdir(target_dir):
        print(f"Error: {target_dir} no es un directorio válido")
        sys.exit(1)
    
    suspicious_files = scan_directory(target_dir)
    print(f"\nTotal de archivos sospechosos encontrados: {len(suspicious_files)}") 